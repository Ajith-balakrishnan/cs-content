#   (c) Copyright 2014 Hewlett-Packard Development Company, L.P.
#   All rights reserved. This program and the accompanying materials
#   are made available under the terms of the Apache License v2.0 which accompany this distribution.
#
#   The Apache License is available at
#   http://www.apache.org/licenses/LICENSE-2.0
#
####################################################

general:
  artifacts:
    - "builder.log"
    
machine:
  pre:
    - sudo curl -L -o /usr/bin/docker 'http://s3-external-1.amazonaws.com/circle-downloads/docker-1.6.2-circleci'; sudo chmod 0755 /usr/bin/docker; true

  services:
    - docker

dependencies:
#  cache_directories:
#    - "~/docker"
  override:
    - docker info
    - docker images
#    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi

test:
  pre:
     - chmod +x ci-env/create_droplets.sh
     - ci-env/create_droplets.sh
     - if [ "${CIRCLE_NODE_INDEX}" = "1" ]; then docker run -d -p 49165:8080 jenkins; fi:
          parallel: true
     - wget https://github.com/CloudSlang/cloud-slang/releases/download/cloudslang-0.8.RC1/cslang-builder.zip:
          parallel: true
     - docker run -d -p 8500:8500 -p 8600:8600/udp fhalim/consul
     - unzip cslang-builder.zip -d cslang-builder:
          parallel: true
     - chmod +x cslang-builder/bin/cslang-builder:
          parallel: true
     - mkdir cslang-builder/lib/Lib:
          parallel: true
     - pip install -r python-lib/requirements.txt -t cslang-builder/lib/Lib:
          parallel: true
     - chmod +x ci-env/prepare_env.sh
     - ci-env/prepare_env.sh
  override:
    - case $CIRCLE_NODE_INDEX in 0) ls -l && ./cslang-builder/bin/cslang-builder -ts coreos,!default -cov ;; 1) ls -l && ./cslang-builder/bin/cslang-builder -ts default,jenkins -cov ;; esac: # TODO: remove ls
        parallel: true
  post:
    - chmod +x ci-env/cleanup_env.sh
    - ci-env/cleanup_env.sh
